networks:
  adapter-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16

services:

  tester:
    build:
      context: ${MODULE_ROOT_FLD:-}
      dockerfile_inline: |
        FROM python:3.12-slim
        
        RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

        ENV VIRTUAL_ENV=/opt/venv
        RUN python -m venv $$VIRTUAL_ENV
        ENV PATH="$$VIRTUAL_ENV/bin:$$PATH"

        WORKDIR /app/module

        COPY setup.py .
        RUN mkdir -p LedgerAdapter && touch LedgerAdapter/__init__.py

        RUN pip install --no-cache-dir --upgrade pip setuptools wheel \
          && pip install --no-cache-dir . \
          && rm -rf LedgerAdapter setup.py
    image: python/adapter-tester
    environment:
      - MODULE_ROOT_FLD=${MODULE_ROOT_FLD-}
      - NODE_URL=${NODE_URL:-}
      - GENESIS_CONTRACTS_PATH=${GENESIS_CONTRACTS_PATH:-}
      - CA_CERTIFICATE_PATH=${CA_CERTIFICATE_PATH:-} 
      - TEST_FILE=${TEST_FILE:-}
      - USERNAME_ROOT=${USERNAME_ROOT:-}
      - PASSWORD_ROOT=${PASSWORD_ROOT:-}
      - USERNAME_ETH=${USERNAME_ETH:-}
      - PASSWORD_ETH=${PASSWORD_ETH:-}
      - USERNAME_PUBLIC=${USERNAME_PUBLIC:-}
      - PASSWORD_PUBLIC=${PASSWORD_PUBLIC:-}
    volumes:
      - ${MODULE_ROOT_FLD:-/tmp}:/app/module
      - ${GENESIS_CONTRACTS_PATH:-/dev/null}:/app/genesis-contracts.json:ro
      - ${CA_CERTIFICATE_PATH:-/dev/null}:/app/ca-certificate.pem
    entrypoint: ["sh", "-ec"]
    command:
      - |
        pip install -e /app/module --no-deps
        pytest -v -s /app/module/tests/LedgerAdapter/$$TEST_FILE
    networks:
      - adapter-net

  rescale-onlykey:
    image: ${RESCALE_NODE_IMAGE:-}
    environment:
      - P2P_DISCOVERY=${BESU_NODE_IP:-}
    volumes:
      - /dev/null:/app/node/auth.toml
      - /tmp:/app/node/cert
    networks:
      adapter-net:
        ipv4_address: ${BESU_NODE_IP:-}

  rescale-auth:
    image: ${RESCALE_NODE_IMAGE:-}
    environment:
      - P2P_DISCOVERY=${BESU_NODE_IP:-}
    volumes:
      # - /dev/null:/app/node/auth.toml
      - /tmp:/app/node/cert
    networks:
      adapter-net:
        ipv4_address: ${BESU_NODE_IP:-}

  rescale-tls:
    image: ${RESCALE_NODE_IMAGE:-}
    environment:
      - P2P_DISCOVERY=${BESU_NODE_IP:-}
    volumes:
      - /dev/null:/app/node/auth.toml
      # - /tmp:/app/node/cert
    networks:
      adapter-net:
        ipv4_address: ${BESU_NODE_IP:-}
